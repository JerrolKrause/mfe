<div id="loan-products-grid">
  <p-table
    dataKey="id"
    [value]="loanProducts ?? []"
    [tableStyle]="{ 'min-width': '50rem' }"
    [expandedRowKeys]="expandedRows"
    (onRowExpand)="onRowExpand($event)"
    (onRowCollapse)="onRowCollapse($event)"
  >
    <!--
  <ng-template pTemplate="caption">
    <div class="flex align-items-center justify-content-between">
      <h2 class="mb-0">
        <lib-icons icon="money-check-alt"></lib-icons>
        Loan Products
      </h2>
    </div>
  </ng-template>
-->
    <ng-template pTemplate="header">
      <tr>
        @for(column of columns; track column; let index = $index) {
        <th
          [pSortableColumn]="column.prop"
          [ngClass]="{ 'text-end': index === columns.length - 1 }"
        >
          <span [innerHTML]="column.label" class="me-2"></span>
        </th>
        }
      </tr>
    </ng-template>
    <ng-template
      pTemplate="body"
      pTemplate="body"
      let-product
      let-expanded="expanded"
      let-rowIndex="rowIndex"
    >
      <tr>
        <td>
          <p-button
            type="button"
            pRipple
            [pRowToggler]="product"
            [text]="true"
            [rounded]="true"
            [plain]="true"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
          />
        </td>
        <td>
          @if(product.status.secured) {
          <lib-icons
            icon="lock"
            pTooltip="Secured"
            tooltipPosition="bottom"
          ></lib-icons>
          } @else {
          <lib-icons
            icon="lock-open"
            pTooltip="Unsecured"
            tooltipPosition="bottom"
          ></lib-icons>
          }
        </td>
        <td>{{ product.vehicles }}</td>
        <td>{{ product.cashOut | currency : 'USD' : 'symbol' : '1.0-2' }}</td>
        <td>
          {{ product.loanAmount | currency : 'USD' : 'symbol' : '1.0-2' }}
        </td>
        <td>
          {{ product.monthlyPayment | currency : 'USD' : 'symbol' : '1.0-2' }}
        </td>
        <td>
          {{ product.paymentImpact | currency : 'USD' : 'symbol' : '1.0-2' }}
        </td>
        <td>{{ product.term }} mos</td>
        <td>{{ product.apr }}%</td>
        <td>{{ product.ndi | currency : 'USD' : 'symbol' : '1.0-2' }}</td>
        <td>
          @if(product.status.systemGenerated) {
          <lib-icons
            icon="info-circle"
            class="me-2 grey"
            pTooltip="System generated quote, cannot be removed"
            tooltipPosition="bottom"
          ></lib-icons>
          } @if(product.status.approved) {
          <lib-icons
            icon="thumbsup"
            class="me-2 green"
            pTooltip="This quote is approved"
            tooltipPosition="bottom"
          ></lib-icons>
          } @if(product.status.rejected) {
          <lib-icons
            icon="thumbsdown"
            class="me-2 orange"
            pTooltip="This quote is rejected"
            tooltipPosition="bottom"
          ></lib-icons>
          } @if(product.status.customerSelected) {
          <lib-icons
            icon="user"
            class="me-2 blue"
            pTooltip="This quote has been selected by the customer"
            tooltipPosition="bottom"
          ></lib-icons>
          } @if(product.status.invalid) {
          <lib-icons
            icon="exclamation-triangle"
            class="me-2 red"
            [pTooltip]="product.status.invalid"
            tooltipPosition="bottom"
          ></lib-icons>
          }
        </td>
        <td class="text-end">
          <p-splitButton
            label="Info"
            appendTo="body"
            icon="pi pi-info-circle"
            [model]="actions[rowIndex]"
            (onClick)="op.toggle($event)"
          ></p-splitButton>
          <p-overlayPanel #op>
            <div class="p-2">
              <table class="table table-sm table-striped mb-0">
                <tbody>
                  <tr>
                    <td><strong>System Decision</strong></td>
                    <td>$18,500</td>
                  </tr>
                  <!--
                  <tr>
                    <td><strong>PTI</strong></td>
                    <td>36%</td>
                  </tr>
                  <tr>
                    <td><strong>LTV</strong></td>
                    <td>120</td>
                  </tr>
                  -->
                </tbody>
              </table>
            </div>
          </p-overlayPanel>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-product>
      <tr>
        <td [attr.colspan]="columns.length + 1">
          <div class="p-3">
            <app-sub-products-grid
              [products]="product.subProducts"
              [colLength]="columns.length + 1"
            ></app-sub-products-grid>

            <div class="text-end">
              <p-button
                class="me-2"
                (click)="
                  modalOpen.emit({
                    type: SubProductType.Credit,
                    productId: product.id
                  })
                "
                >Add Credit Product</p-button
              >
              <p-button
                (click)="
                  modalOpen.emit({
                    type: SubProductType.Noncredit,
                    productId: product.id
                  })
                "
                >Add Non-Credit Product</p-button
              >
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="columns.length + 1">
          No loan products have been created yet.
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
